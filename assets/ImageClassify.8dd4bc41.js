import{r as x,a as c,j as o,F as L}from"./index.1da63547.js";import{e as D,g as k,h as B,l as P,z as U,s as q,f as K,d as N,j as O,t as T}from"./index.5de002d9.js";import{u as V}from"./useSetState.12359b3d.js";import{u as W}from"./useMount.d3fcb0a7.js";import{B as S}from"./button.52476b55.js";import{D as w}from"./index.305a4de5.js";import{S as $}from"./Skeleton.405e258d.js";import{S as G}from"./index.6cff07d6.js";import{I as H}from"./index.91e89195.js";import{m as b}from"./index.6265da24.js";import"./index.a2923c53.js";import"./isVisible.7ca29fb7.js";import"./render.43ae6a3d.js";import"./AntdIcon.78424b7e.js";import"./Compact.9bf7b630.js";import"./CloseOutlined.2f07144d.js";import"./useFlexGapSupport.aeea6946.js";import"./index.434e4ebc.js";import"./CloseCircleFilled.ad36d395.js";import"./useMergedState.31cb9ce1.js";import"./CheckCircleFilled.3f6be613.js";import"./KeyCode.b4f9faf0.js";const F=10;function xe(){const p=x.exports.useRef(null),u=x.exports.useRef(),l=x.exports.useRef(),f=x.exports.useRef(),v=x.exports.useRef(),[s,i]=V({name:"hans",modelReady:!1,videoStatus:"unstart",training:!1,list:[],epoch:0,loss:0});W(async()=>{const t=await P("/glow/mobilenet_v1_0.25_224/mobilenet.json");t.predict(U([1,224,224,3])).dispose(),v.current=t;const e=q();e.add(K({inputShape:[7,7,256]})),e.add(N({units:100,activation:"relu"})),e.add(N({units:F,activation:"softmax"}));const n=O.adam(1e-4);e.compile({optimizer:n,loss:"categoricalCrossentropy"}),f.current=e,i({modelReady:!0})});const j=()=>{if(s.videoStatus==="pending")return;i({videoStatus:"pending"});const t=p.current,{width:r,height:e}=t;navigator.mediaDevices.getUserMedia({video:{width:r,height:e}}).then(n=>{t.srcObject=n,i({videoStatus:"started"})}).catch(n=>{b.error("\u6444\u50CF\u5934\u6545\u969C"),i({videoStatus:"faulted"})})},E=()=>{if(!u.current||!l.current||!f.current)return;i({training:!0});const t=~~(u.current.shape[0]*.4);f.current.fit(u.current,l.current,{batchSize:t,epochs:20,callbacks:{onEpochEnd:(r,e)=>{i(n=>({epoch:n.epoch+1,loss:e.loss}))},onTrainEnd:()=>{i({training:!1})}}})},_=()=>{var m,y,g,R;if(!f.current||!v.current)return;const t=p.current,r=D(t),n=k.resizeBilinear(r,[224,224]).as4D(1,224,224,3),a=v.current.predict(n);let d=f.current.predict(a).argMax(1).dataSync()[0];console.log(d,(y=(m=s.list.find((M,C)=>d===C))==null?void 0:m.name)!=null?y:"\u672A\u77E5"),b.success((R=(g=s.list.find((M,C)=>d===C))==null?void 0:g.name)!=null?R:"\u672A\u77E5")},z=(t,r)=>{const e=document.createElement("canvas");return e.width=r[0],e.height=r[1],e.getContext("2d").drawImage(t,0,0,r[0],r[1]),e.toDataURL()},I=(t,r)=>{let e=-1,n=s.list.map((a,h)=>a.name===t?(e=h,{...a,count:a.count+1,preview:[r,...a.preview]}):a);return e===-1&&(n=[...n,{name:t,count:1,preview:[r]}],e=n.length-1),i({list:n}),e},A=t=>{var a,h;if(s.videoStatus!=="started")return b.error("\u8BF7\u6253\u5F00\u6444\u50CF\u5934");if(!t)return b.warning("\u8BF7\u8F93\u5165\u540D\u79F0");const r=B(()=>{const d=D(p.current),y=k.resizeBilinear(d,[224,224]).as4D(1,224,224,3),g=v.current.predict(y);return u.current?u.current.concat(g,0):g});(a=u.current)==null||a.dispose(),u.current=r;const e=I(t,z(p.current,[100,100])),n=B(()=>{const d=new Array(F).fill(0).fill(1,e,e+1),m=T(d,[1,F]);return l.current?l.current.concat(m,0):m});(h=l.current)==null||h.dispose(),l.current=n};return c("div",{className:"container mx-auto p-4",children:[c("div",{className:"w-[280px] h-[280px] bg-amber-600 flex items-center justify-center ",children:[o("video",{ref:p,autoPlay:!0,width:280,height:280,style:{display:s.videoStatus==="started"?"block":"none"}}),o(S,{onClick:j,type:"primary",loading:s.videoStatus==="pending",style:{display:s.videoStatus==="started"?"none":"block"},children:"\u6253\u5F00\u6444\u50CF\u5934"})]}),o(w,{}),c($,{active:!0,loading:!s.modelReady,children:[c(G,{className:"flex flex-wrap",children:[o(H,{value:s.name,style:{maxWidth:100},onChange:t=>i({name:t.target.value})}),o(S,{onClick:()=>A(s.name),type:"primary",children:"\u5F55\u5165"})]}),o(w,{}),c("div",{className:"space-x-2 mb-1",children:[o(S,{type:"primary",onClick:E,loading:s.training,children:"\u8BAD\u7EC3"}),o(S,{type:"primary",onClick:_,children:"\u9884\u6D4B"})]}),c("div",{className:"font-bold text-teal-500",children:["epoch: ",s.epoch," loss: ",s.loss]}),o(w,{}),o(L,{children:s.list.map(t=>c("div",{children:[c("div",{className:"font-bold mb-2",children:[o("span",{className:"text-xl",children:t.name}),": ",t.count]}),o("div",{className:"space-x-2 flex overflow-x-auto pb-2",children:t.preview.map((r,e)=>o("img",{src:r},e))})]},t.name))})]})]})}export{xe as default};
